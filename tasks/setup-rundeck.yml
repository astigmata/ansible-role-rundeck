---
- name: Install Rundeck
  ansible.builtin.apt:
    name: rundeck
    state: present
    update_cache: true
  notify: Restart rundeck

- name: Create rundeck directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: rundeck
    group: rundeck
    mode: '0755'
  loop:
    - /var/log/rundeck
    - /var/rundeck/projects

- name: Set correct permissions for Rundeck directories
  ansible.builtin.file:
    path: "{{ item }}"
    owner: rundeck
    group: rundeck
    recurse: true
  loop:
    - /var/lib/rundeck
    - /var/log/rundeck
    - /etc/rundeck

- name: Configure Rundeck framework properties
  ansible.builtin.lineinfile:
    path: /etc/rundeck/framework.properties
    regexp: "^framework.server.url"
    line: "framework.server.url = {{ rundeck_server_url }}"
    backup: true
  notify: Restart rundeck

- name: Configure Rundeck server settings
  ansible.builtin.lineinfile:
    path: /etc/rundeck/rundeck-config.properties
    regexp: "{{ item.regexp }}"
    line: "{{ item.line }}"
    backup: true
  loop:
    - regexp: "^grails.serverURL"
      line: "grails.serverURL={{ rundeck_server_url }}"
    - regexp: "^server.address"
      line: "server.address={{ rundeck_listen_address }}"
    - regexp: "^server.port"
      line: "server.port={{ rundeck_port }}"
  notify: Restart rundeck

- name: Create admin user properties file
  ansible.builtin.copy:
    content: |
      {{ rundeck_admin_user }}:MD5:{{ (rundeck_admin_password | hash('md5')) }},user,admin,architect
    dest: /etc/rundeck/realm.properties
    owner: rundeck
    group: rundeck
    mode: '0640'
    backup: true
  notify: Restart rundeck

- name: Configure Rundeck login module
  ansible.builtin.copy:
    content: |
      RDpropertyfilelogin {
          org.eclipse.jetty.jaas.spi.PropertyFileLoginModule required
          debug="true"
          file="/etc/rundeck/realm.properties";
      };
    dest: /etc/rundeck/jaas-loginmodule.conf
    owner: rundeck
    group: rundeck
    mode: '0644'
    backup: true
  notify: Restart rundeck

- name: Configure Rundeck service environment
  ansible.builtin.template:
    src: profile.j2
    dest: /etc/rundeck/profile
    owner: rundeck
    group: rundeck
    mode: '0644'
  notify: Restart rundeck

- name: Enable and start Rundeck service
  ansible.builtin.systemd:
    name: rundeckd
    enabled: true
    state: started

- name: Wait for Rundeck to be available
  ansible.builtin.wait_for:
    port: "{{ rundeck_port }}"
    host: "{{ rundeck_listen_address if rundeck_listen_address != '0.0.0.0' else '127.0.0.1' }}"
    delay: 10
    timeout: 120

- name: Verify Rundeck API availability
  ansible.builtin.uri:
    url: "{{ rundeck_server_url }}/api/14/system/info"
    method: GET
    user: "{{ rundeck_admin_user }}"
    password: "{{ rundeck_admin_password }}"
    force_basic_auth: true
    status_code: [200]
  register: api_test
  retries: 6
  delay: 10
  until: api_test is not failed

- name: Create default project
  ansible.builtin.uri:
    url: "{{ rundeck_server_url }}/api/14/projects"
    method: POST
    headers:
      Content-Type: "application/json"
      Accept: "application/json"
    body_format: json
    body:
      name: "default-project"
      description: "Default project for Rundeck"
      config:
        project.description: "Default project created during setup"
    user: "{{ rundeck_admin_user }}"
    password: "{{ rundeck_admin_password }}"
    force_basic_auth: true
    status_code: [201, 409]
  register: project_creation
  retries: 3
  delay: 5

- name: Display setup completion
  ansible.builtin.debug:
    msg:
      - "Rundeck installation completed!"
      - "Access URL: {{ rundeck_server_url }}"
      - "Username: {{ rundeck_admin_user }}"
      - "Service: sudo systemctl status rundeckd"
